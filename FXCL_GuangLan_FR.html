<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>光缆返修处理-复绕</title>
    <meta name="viewport" content="initial-scale=1, maximum-scale=1">
    <link rel="shortcut icon" href="/favicon.ico">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <link rel="stylesheet" href="css/swiper.min.css">
    <link rel="stylesheet" href="css/storage.css">
    <link rel="stylesheet" href="css/loading.css">
    <link rel="stylesheet" href="css/mui.min.css">
    <link rel="stylesheet" href="css/mui.picker.min.css">
    <link rel="stylesheet" href="css/mui.poppicker.css">
    <style type="text/css">
        .btn,.title{
            font-family: "微软雅黑";
            font-size: 16px;
        }
        .title{
            font-size: 22px;
            font-weight: 800;
            line-height: 35px;
        }
        .devideLine{
            width: 98%;
            height: 2px;
            background: #666666;
            margin-top: 15px;
        }
        .textarea{
            width: 100%;
            min-height: 60px;
            margin-top: 20px;
            margin-left: auto;
            margin-right: auto;
            padding: 15px;
            outline: 0;
            border: 1px solid #999999;
            font-size: 16px;
            line-height: 24px;
            word-wrap: break-word;
            overflow-x: hidden;
            overflow-y: auto;
        }
        .box-container{
            margin-top: 30px;
            padding-bottom: 30px;
            border: 1px solid #999999;
            position: relative;
        }
        .title-p{
            position: absolute;
            font-family: "微软雅黑";
            font-size: 18px;
            font-weight: bold;
            top: -15px;
            left: 30px;
            z-index: 100;
            padding-left: 10px;
            padding-right: 10px;
            background: #ffffff;
        }
        .input-xgit{
            border: 1px solid #cccccc;
            outline: none;
            height: 35px;
            line-height: 30px;
            padding: 3px 5px;
        }
        .inner-title{
            font-family: "微软雅黑";
            font-size: 16px;
            line-height: 35px;
        }
        .modal-header{
            background: #3A89ED;
            border-top-left-radius: 5px;
            border-top-right-radius: 5px;
        }
        .modal-title{
            font-family: 微软雅黑;color: white;
        }
        .textinfo{
            font-size: 20px;font-family: 微软雅黑;line-height: 150px;
        }
        .nav-pills li{
            border: 1px solid #cccccc;
            border-radius: 5px;
            background: #cccccc;
        }
        .nav-pills li a{
            font-size: 16px;font-family: 微软雅黑;color: #ffffff;
        }
    </style>
</head>
<body>
<div id="wrap-content" style="overflow: hidden; overflow-y: auto;background: #ffffff">
    <div class="container" style="margin-top: 30px;padding: 0px;">
        <div class="row">
            <div class="col-xs-3 col-md-3">
                <p class="center-block text-center title">返修处理--复绕</p>
            </div>
            <div class="col-xs-3 col-md-3"></div>
            <div class="col-xs-2 col-md-2">
                <button id="saveBtn" type="button" class="btn btn-primary center-block" style="width: 90%;">保存</button>
            </div>
            <div class="col-xs-2 col-md-2">
                <button id="finishBtn" type="button"  class="btn btn-primary center-block" style="width: 90%;">复绕完成</button>
            </div>
            <div class="col-xs-2 col-md-2">
                <button id="clearBtn" type="button" class="btn btn-primary center-block" style="width: 90%;">清除复绕信息</button>
            </div>
        </div>
    </div>
    <div class="devideLine center-block"></div>
    <div class="container" style="padding: 0px;">
        <div id="infoContent" class="textarea" contenteditable="false"><br /></div>
    </div>
    <div class="container box-container" style="margin-bottom: 15px;">
        <p class="text-center title-p">复绕参数录入</p>
        <div class="row" style="margin-top: 50px;">
            <div class="col-xs-4 col-md-4">
                <div class="input-group">
                    <span class="input-group-addon">复绕机台</span>
                    <input id="jitai_code" type="text" class="form-control" aria-describedby="jitai_code" readonly="readonly" style="background: #ffffff;">
                    <p id="GUID" style="display: none;"></p>
                    <p id="FGCode" style="display: none;"></p>
                    <p id="MacCode" style="display: none;"></p>
                </div>
            </div>
            <div class="col-xs-4 col-md-4">
                <div class="input-group">
                    <span class="input-group-addon" >复绕长度(m)</span>
                    <input id="fr_length" type="text" class="form-control" aria-describedby="fr_length">
                </div>
            </div>
            <div class="col-xs-4 col-md-4">
                <div class="input-group">
                    <span class="input-group-addon" >作业人员</span>
                    <input id="operatorname" type="text" class="form-control" readonly="readonly">
                </div>
            </div>
        </div>
        <div class="row" style="margin-top: 30px;">
            <div class="col-xs-4 col-md-4">
                <div class="input-group">
                    <span class="input-group-addon" >作业时间</span>
                    <input id="operatortime" type="text" class="form-control" aria-describedby="work_time" readonly="readonly">
                </div>
            </div>
            <div class="col-xs-4 col-md-4">
                <div class="input-group">
                    <span class="input-group-addon" >状态</span>
                    <input id="work_state" type="text" class="form-control" aria-describedby="work_state" readonly="readonly">
                </div>
            </div>
            <div class="col-xs-4 col-md-4">
                <div class="input-group">
                    <span class="input-group-addon" >线速(m/min)</span>
                    <input id="line_speed" type="text" class="form-control" aria-describedby="line_speed">
                </div>
            </div>
        </div>
        <div class="row" style="margin-top: 30px;">
            <div class="col-xs-6 col-md-6">
                <div class="input-group">
                    <span class="input-group-addon" >光缆盘具</span>
                    <input id="gl_pan" type="text" class="form-control" aria-describedby="gl_pan" readonly="readonly" style="background: #ffffff;">
                </div>
            </div>
            <div class="col-xs-6 col-md-6">
                <div class="input-group">
                    <span class="input-group-addon" >目标仓库</span>
                    <input id="storage" type="text" class="form-control" aria-describedby="storage" readonly="readonly">
                </div>
            </div>
        </div>
        <div class="row" style="margin-top: 30px;">
            <div class="col-xs-12 col-md-12">
                <div class="input-group">
                    <span class="input-group-addon" >印字内容</span>
                    <input id="print_text" type="text" class="form-control" aria-describedby="print_text" style="background: #ffffff;">
                </div>
            </div>
        </div>
        <div class="row" style="padding: 15px;margin-top: 30px;">
            <p>备注</p>
            <div id="remark" class="textarea" contenteditable="true"><br /></div>
        </div>
    </div>
</div>
<!--loading-->
<div id="loading" class="spinner">
    <div class="bounce1"></div>
    <div class="bounce2"></div>
    <div class="bounce3"></div>
</div>

<!--bootstrap模态框-->
<div id="myModal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="gridSystemModalLabel">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title center-block text-center" id="gridSystemModalLabel">提示</h4>
            </div>
            <div class="modal-body"style="height: 150px">
                <div class="row">
                    <div class="col-md-2 col-xs-2"></div>
                    <div class="col-md-8 col-xs-8 center-block text-center textinfo">确定复绕完成吗？</div>
                    <div class="col-md-2 col-xs-2"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
                <button id="sureFinishBtn" type="button" class="btn btn-primary">确认</button>
            </div>
        </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
</div><!-- /.modal -->



<script type="text/javascript" src="js/doT.js"></script>
<script type="text/javascript" src="js/mui.js"></script>
<script type="text/javascript" src="js/mui.picker.min.js"></script>
<script type="text/javascript" src="js/mui.poppicker.js"></script>
<script type='text/javascript' src='js/jquery-2.0.3.min.js' charset='utf-8'></script>
<script type='text/javascript' src='js/bootstrap.min.js' charset='utf-8'></script>
<script type="text/javascript" src="js/swiper.min.js"></script>
<script type="text/javascript" src="js/ftcommon.js"></script>
<script type="text/javascript">
    var template;
    var my_macno;
    var myusername;
    var Timer;
    var publicNum;
    var Quality;
    var GUID;
    $(function(){
        android.startLoading();
        android.windowReady();
        $('#wrap-content').css('height',$(window).height()+'px');
        $('#sureFinishBtn').click(function () {
            sureFinishBtn();
        });

        $('#clearBtn').click(function () {
            var guid=$('#GUID').html();
            var operatorname = $("#operatorname").val();
            var url = xgxx.server_Domain+'OSheathRepair/GLRepairFuRaoDelete?callback=callback&Guid='+guid+'&UserCode=""&UserName='+operatorname;
            android.print(url);
            try {
                android.startLoading();
                $.ajax(url,{
                    type:"get",
                    dataType : "text",
                    data:{
                    },
                    success: function (result, status) {
                        android.endLoading();
                        var dataStr = result.substring(9,result.length-1);
                        android.print(dataStr);
                        var jsonData = eval("["+dataStr+"]");
                        android.print(JSON.stringify(jsonData));
                        if(jsonData[0].Code=="200"){
                            android.showToast("数据清除完成");
                            $('#jitai_code').val("");//复绕机台
                            $('#fr_length').val("");//复绕长度
                            $('#operatorname').val("");//作业人员
                            $('#operatortime').val("");//作业时间
                            $('#work_state').val("");//状态
                            $('#line_speed').val("");//复绕线速
                            $('#gl_pan').val("");//盘号
                            $('#storage').val("");//目标仓库
                            $('#print_text').val("");//印字内容
                            $('#remark').val("");//备注
                            window.location.reload();//刷新当前页面.
                        }else{
                            android.showToast(jsonData[0].Msg);
                        }
                    },
                    error: function (error) {
                        android.endLoading();
                    }
                });
            }catch (e) {
                android.print(JSON.stringify(e));
            }
        });
    });

    //设置用户名
    function setusername(username,server_Domain,GUID) {
        xgxx.server_Domain=server_Domain;
        myusername=username;
        GUID=GUID;
        $('#GUID').html(GUID);
        getInfo(GUID);//获取基础信息
        saveInfo();
        finishFr();
        clearInfo();
    }

    function getInfo(GUID) {
        android.print(myusername);
        android.print(GUID);
        xgxx.ajax('OSheathRepair/XGIT_GLRepair_GetSourceInfo?callback=callback',{
            data:{
                Guid:GUID,
                Promethod:"1"
            },
            success: function (result, status) {
                android.endLoading();
                var jsonData=eval(result.Data);
                android.print(JSON.stringify(jsonData));
                getPrintContent();//获取印字内容
                if(result.Msg=="1"){
                    android.print(JSON.stringify(jsonData[0].Info));
                    $('#jitai_code').val(jsonData[0].MacName);
                    $('#MacCode').html(jsonData[0].MacCode);
                    $('#infoContent').html(jsonData[0].Info);
                    $('#FGCode').html(jsonData[0].FGCode)
                    $('#fr_length').val(jsonData[0].FGLen);//复绕长度
                    var operatorTime=jsonData[0].OperatorTime;
                    operatorTime=operatorTime.replace('T', ' ');
                    operatorTime=operatorTime.substring(0,16);
                    if(jsonData[0].OperatorName=="" || jsonData[0].OperatorName==undefined){
                        $('#operatorname').val(myusername);//作业人员
                    }else{
                        $('#operatorname').val(jsonData[0].OperatorName);//作业人员
                    }
                    if(jsonData[0].OperatorTime=="" || jsonData[0].OperatorTime==undefined){
                        $('#operatortime').val(Format(new Date(),"yyyy-MM-dd HH:mm"));//作业时间
                    }else{
                        $('#operatortime').val(operatorTime);//作业时间
                    }
                    $('#work_state').val(jsonData[0].StateView);//状态
                    $('#line_speed').val(jsonData[0].Speed);//线速
                    $('#gl_pan').val(jsonData[0].PanDesc);//光缆盘具
                    $('#gl_pan')[0].setAttribute("data-code",jsonData[0].PanGuid);//盘具GUID
                    $('#storage').val(jsonData[0].TargetStorageName);//目标仓库
                    $('#print_text').val(jsonData[0].FGMark);//印字内容
                    $('#remark').val(jsonData[0].Remark);//备注
                    $('#storage').data("TargetStorage",result.InputInfo[0].TargetStorage);//目标仓库
                }
            },
            error: function (error) {
                android.endLoading();
                closeLoading();
                alert("错误"+JSON.stringify(error));
            }
        });
    }


    //获取印字内容信息
    function  getPrintContent() {
        xgxx.ajax('OSheathRepair/GetYinZiList?callback=callback',{
            success: function (result, status) {
                android.endLoading();
                var resultData=eval(result.Data);
                android.print("resultData"+JSON.stringify(resultData));
                var jsonData=[];
                for(var i=0;i<resultData.length;i++){
                    var obj=new Object();
                    obj.value=resultData[i].Code;
                    obj.text=resultData[i].Descs;
                    jsonData.push(obj);
                }
                android.print(JSON.stringify(jsonData));
                var PrintPicker = new mui.PopPicker();
                PrintPicker.setData(jsonData);
                $('#print_text').click(function (event) {
                    var dom = $(this)[0];
                    PrintPicker.show(function(items) {
                        dom.value = items[0].text;
                        dom.setAttribute("Code",items[0].value);
                    });
                });
                getPanInfo();
            },
            error: function (error) {
                android.endLoading();
                android.print("错误"+JSON.stringify(error));
            }
        });
    }
    //获取所有盘具信息
    function getPanInfo() {
        xgxx.ajax('OSheathRepair/GetPanJuList?callback=callback',{
            success: function (result, status) {
                android.endLoading();
                var jsonData=[];
                for(var i=0;i<result.PanJu.length;i++){
                    var datas = {};
                    datas['value'] = result.PanJu[i].MaterialCode;
                    datas['text'] = result.PanJu[i].DefaultName;
                    var objarray=[];
                    for(var j=0;j<result.PanJuInfo.length;j++){
                        if(result.PanJuInfo[j].MaterialCode==result.PanJu[i].MaterialCode){
                            var item = {};
                            item['value'] = result.PanJuInfo[j].MaterialCode;
                            item['text'] = result.PanJuInfo[j].DefaultName+"("+result.PanJuInfo[j].PanDesc+")";
                            objarray.push(item);
                        }
                    }
                    datas['children'] = objarray;
                    jsonData.push(datas);
                }
                android.print("=====!!!!!!====="+JSON.stringify(jsonData));
                var cityPicker = new mui.PopPicker({
                    layer: 2
                });
                cityPicker.setData(jsonData);
                $('#gl_pan').click(function (event) {
                    var dom = $(this)[0];
                    cityPicker.show(function(items) {
                        android.print(JSON.stringify(items));
                        dom.value = items[1].text;
                        dom.setAttribute("data-code",items[1].value);
                    });
                });
                getMacInfo();
            },
            error: function (error) {
                android.endLoading();
                android.print("错误"+JSON.stringify(error));
            }
        });
    }

    //获取该工序对应的所有设备信息
    function getMacInfo() {
        xgxx.ajax('OSheathRepair/GetMacList?callback=callback&ProcessCode=sys006',{
            success: function (result, status) {
                android.endLoading();
                android.print(JSON.stringify(result));
                var jsonData=[];
                for(var i=0;i<result.Process.length;i++){
                    var datas = {};
                    datas['value'] = result.Process[i].Code;
                    datas['text'] = result.Process[i].ProcessName;
                    var objarray=[];
                    for(var j=0;j<result.MacInfo.length;j++){
                        var item = {};
                        item['value'] = result.MacInfo[j].Code;
                        item['text'] = result.MacInfo[j].MacName+"("+result.MacInfo[j].Position+")";
                        objarray.push(item);
//                        if(result.MacInfo[j].Code==result.Process[i].Code){
//                            var item = {};
//                            item['value'] = result.MacInfo[j].Code;
//                            item['text'] = result.MacInfo[j].MacName+"("+result.MacInfo[j].Position+")";
//                            objarray.push(item);
//                        }
                    }
                    datas['children'] = objarray;
                    jsonData.push(datas);
                }
                var MacPicker = new mui.PopPicker({
                    layer: 2
                });
                MacPicker.setData(jsonData);
                $('#jitai_code').click(function (event) {
                    var dom = $(this)[0];
                    MacPicker.show(function(items) {
                        android.print(JSON.stringify(items));
                        dom.value = items[1].text;
                        dom.setAttribute("Code",items[1].value);
                        $('#MacCode').html(items[1].value);
                    });
                });
                android.endLoading();
            },
            error: function (error) {
                android.endLoading();
                android.print("错误"+JSON.stringify(error));
            }
        });
    }

    function saveInfo() {
        $('#saveBtn').click(function () {
//            if($('#MacCode').html()=="" || $('#MacCode').html()==null){
//                android.showToast("请选择复绕机台");
//                return;
//            }
//            if($('#fr_length').val()=="" || $('#fr_length').val()==null){
//                android.showToast("请输入复绕长度");
//                return;
//            }
//            if($('#line_speed').val()=="" || $('#line_speed').val()==null){
//                android.showToast("请输入线速");
//                return;
//            }
            var savejson=[];
            var jsonData = new Object();
            jsonData.GUID=$('#GUID').html();
            jsonData.FGCode=$('#FGCode').html();
            jsonData.ADirectB=-1;
            if($('#storage').data("TargetStorage")==null){
                jsonData.TargetStorage="";
            }else{
                jsonData.TargetStorage=$('#storage').data("TargetStorage");
            }
            jsonData.FGLen=$('#fr_length').val();
            jsonData.FGMark=$('#print_text').val();
            jsonData.Speed=$('#line_speed').val();
            jsonData.CablePanCode=$('#gl_pan')[0].getAttribute("data-code");
            jsonData.MacCode=$('#MacCode').html();
            jsonData.Operator="";
            jsonData.OperatorName=$('#operatorname').val();
            jsonData.OperatorTime=$('#operatortime').val();
            jsonData.Remark=$('#remark').val();
            savejson.push(jsonData);
            android.print(JSON.stringify(savejson));
            android.startLoading();
            var url = xgxx.server_Domain+'OSheathRepair/GetGLRepairSaveFuRaoInfo?callback=callback&savejson='+JSON.stringify(savejson);
            android.print(url);
            $.ajax(url,{
                type:"get",
                dataType : "text",
                data:{
                },
                success: function (result, status) {
                    android.endLoading();
                    android.showToast(JSON.stringify(result));
                    var index = result.indexOf("(");
                    var resultData=result.substring(index+1,result.length-1);
                    android.print(resultData);
                    resultData = eval("["+resultData+"]");
                    if(resultData[0].Code=="400"){
                        android.showToast(resultData[0].Msg);
                    }else if(resultData[0].Code=="200"){
                        android.showToast(resultData[0].Msg);
                        $('#StateView').val("复绕中");
                    }
//                    if(result=='callback({\"Code\":\"200\",\"Msg\":\"保存成功！\"})'){
//                        android.showToast("保存成功");
//                    }else{
//                        android.showToast("保存失败");
//                    }
                },
                error: function (error) {
                    android.endLoading();
                    android.print("错误"+JSON.stringify(error));
                }
            });
        });
    }

    //复绕完成
    function finishFr() {
        $('#finishBtn').click(function () {
            var jitai_code=$('#jitai_code').val();//复绕机台
            var OrdrLen=$('#fr_length').val();//复绕长度
            var operatorname=$('#operatorname').val();//作业人员
            var operatortime=$('#operatortime').val();//作业时间
            var StateView=$('#work_state').val();//状态
            var fr_speed=$('#line_speed').val();//复绕线速
            var pan_code=$('#gl_pan').val();//盘号
            var print_text=$('#print_text').val();//印字内容

            if(jitai_code=="" || jitai_code==null){
                android.showToast("复绕机台不能为空");
                return;
            }
            if(OrdrLen=="" || OrdrLen==null){
                android.showToast("复绕长度不能为空");
                return;
            }
            if(operatorname=="" || operatorname==null){
                android.showToast("作业人员不能为空");
                return;
            }
            if(operatortime=="" || operatortime==null){
                android.showToast("作业时间不能为空");
                return;
            }
            if(StateView=="" || StateView==null){
                android.showToast("状态不能为空");
                return;
            }
            if(fr_speed=="" || fr_speed==null){
                android.showToast("复绕线速不能为空");
                return;
            }
            if(print_text=="" || print_text==null){
                android.showToast("印字内容不能为空");
                return;
            }
            if(pan_code=="" || pan_code==null){
                android.showToast("盘号不能为空");
                return;
            }

            $('#myModal').on('shown.bs.modal', function (e) {
                // 关键代码，如没将modal设置为 block，则$modala_dialog.height() 为零
                $(this).css('display', 'block');
                var modalHeight=$(window).height() / 2 - $('#myModal .modal-dialog').height() / 2;
                $(this).find('.modal-dialog').css({
                    'margin-top': modalHeight
                });
            }).modal({
                keyboard:true//当按下esc键时，modal框消失
            });
        });
    }

    //确定复绕完成
    function sureFinishBtn() {
        var guid=$('#GUID').html();
        var operatorname = $("#operatorname").val();
        android.startLoading();

        var url=xgxx.server_Domain+'OSheathRepair/GLRepairFuRaoCompleted?callback=callback&Guid='+guid+'&UserCode=""&UserName='+operatorname;
        $.ajax(url,{
            type:"get",
            dataType : "text",
            data:{
            },
            success: function (result, status) {
                android.endLoading();
                result = result.substring(9,result.length-1);
                result = eval("["+result+"]");
                if(result[0].Code=="400"){
                    android.showToast(result[0].Msg);
                }else if(result[0].Code=="200"){
                    android.showToast(result[0].Msg);
                    android.closeActivity();
                }
                $('#myModal').modal('hide');
            },
            error: function (error) {
                android.endLoading();
                android.print("错误"+JSON.stringify(error));
            }
        });


//        xgxx.ajax('OSheathRepair/GLRepairFuRaoCompleted?callback=callback',{
//            data:{
//                Guid:guid,
//                UserCode:"",
//                UserName:operatorname
//            },
//            success: function (result, status) {
//                android.endLoading();
//                android.print(result);
//                android.showToast(result);
//                result = result.substring(9,result.length-1);
//                result = eval("["+result+"]");
//                if(result[0].Code=="400"){
//                    android.showToast(result[0].Msg);
//                }else if(result[0].Code=="200"){
//                    android.showToast(result[0].Msg);
//                    android.closeActivity();
//                }
//                $('#myModal').modal('hide');
//            },
//            error: function (error) {
//                android.endLoading();
//            }
//        });


    }

</script>
</body>
</html>
